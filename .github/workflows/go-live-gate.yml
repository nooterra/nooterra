name: go-live-gate

on:
  workflow_dispatch: {}

concurrency:
  group: go-live-gate
  cancel-in-progress: false

jobs:
  s13_gate:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - uses: grafana/setup-k6-action@v1

      - name: Install dependencies
        run: npm ci

      - name: Start Settld API (pg mode)
        run: |
          set -euo pipefail
          STORE=pg \
          NODE_ENV=production \
          DATABASE_URL="postgres://postgres:test@127.0.0.1:5432/postgres" \
          PROXY_PG_SCHEMA="go_live_gate_ci" \
          PROXY_MIGRATE_ON_STARTUP=1 \
          PROXY_OPS_TOKENS="ops_ci:ops_read,ops_write,finance_read,finance_write,audit_read" \
          PORT=3000 \
          node src/api/server.js &
          echo $! > /tmp/settld_pid

      - name: Wait for readiness
        run: |
          set -euo pipefail
          for i in $(seq 1 60); do
            if curl -fsS "http://127.0.0.1:3000/healthz" >/dev/null; then exit 0; fi
            sleep 1
          done
          echo "server did not become ready" >&2
          exit 1

      - name: Run S13 go-live gate
        env:
          BASE_URL: http://127.0.0.1:3000
          OPS_TOKEN: ops_ci
          TENANTS: "3"
          ROBOTS_PER_TENANT: "3"
          BASELINE_JOBS_PER_MIN_PER_TENANT: "10"
          THROUGHPUT_MULTIPLIER: "10"
          DURATION: "120s"
          TARGET_P95_MS: "5000"
          MAX_FAILURE_RATE: "0.05"
          MAX_INGEST_REJECTED_PER_MIN: "50"
          RUN_THROUGHPUT_DRILL: "1"
          ALLOW_THROUGHPUT_SKIP: "0"
          RUN_INCIDENT_REHEARSAL: "1"
          ALLOW_INCIDENT_REHEARSAL_SKIP: "0"
        run: node scripts/ci/run-go-live-gate.mjs

      - name: Materialize launch cutover packet signing key (optional)
        if: ${{ secrets.LAUNCH_CUTOVER_PACKET_SIGNING_PRIVATE_KEY_PEM != '' }}
        env:
          LAUNCH_CUTOVER_PACKET_SIGNING_PRIVATE_KEY_PEM: ${{ secrets.LAUNCH_CUTOVER_PACKET_SIGNING_PRIVATE_KEY_PEM }}
        run: |
          set -euo pipefail
          mkdir -p /tmp/launch-cutover-signing
          printf '%s\n' "${LAUNCH_CUTOVER_PACKET_SIGNING_PRIVATE_KEY_PEM}" > /tmp/launch-cutover-signing/ed25519-private.pem
          chmod 600 /tmp/launch-cutover-signing/ed25519-private.pem

      - name: Run Settld Verified collaboration gate (binding source)
        if: always()
        env:
          DATABASE_URL: postgres://postgres:test@127.0.0.1:5432/postgres
          SETTLD_BASE_URL: http://127.0.0.1:3000
          SETTLD_TENANT_ID: tenant_default
          PROXY_OPS_TOKEN: ops_ci
        run: |
          set -euo pipefail
          npm run -s test:ops:settld-verified-gate -- \
            --level collaboration \
            --bootstrap-local \
            --include-pg \
            --out artifacts/gates/settld-verified-collaboration-gate.json

      - name: Build launch cutover packet
        if: always()
        env:
          LAUNCH_CUTOVER_PACKET_SIGNING_KEY_FILE: ${{ secrets.LAUNCH_CUTOVER_PACKET_SIGNING_PRIVATE_KEY_PEM != '' && '/tmp/launch-cutover-signing/ed25519-private.pem' || '' }}
          LAUNCH_CUTOVER_PACKET_SIGNATURE_KEY_ID: ${{ vars.LAUNCH_CUTOVER_PACKET_SIGNATURE_KEY_ID || '' }}
          SETTLD_VERIFIED_COLLAB_REPORT_PATH: artifacts/gates/settld-verified-collaboration-gate.json
        run: node scripts/ci/build-launch-cutover-packet.mjs

      - name: Upload go-live artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: go-live-gate-${{ github.run_id }}
          path: |
            artifacts/gates/s13-go-live-gate.json
            artifacts/gates/s13-launch-cutover-packet.json
            artifacts/gates/settld-verified-collaboration-gate.json
            artifacts/throughput/10x-drill-summary.json
            artifacts/throughput/10x-drill-k6-summary.json
            artifacts/throughput/10x-incident-rehearsal-summary.json
          if-no-files-found: error

      - name: Remove launch cutover packet signing key
        if: always()
        run: rm -rf /tmp/launch-cutover-signing

      - name: Stop server
        if: always()
        run: |
          set -euo pipefail
          if [[ -f /tmp/settld_pid ]]; then kill "$(cat /tmp/settld_pid)" || true; fi
