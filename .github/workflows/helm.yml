name: helm

on:
  push:
    branches: [main]
  pull_request:
    paths:
      - "deploy/helm/**"
      - "docs/CONFIG.md"
      - ".github/workflows/helm.yml"

jobs:
  lint_and_template:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      - name: helm lint
        run: helm lint deploy/helm/settld --strict

      - name: helm template + kubectl dry-run
        run: |
          set -euo pipefail
          has_apiserver=0
          if kubectl --request-timeout=2s get --raw='/healthz' >/dev/null 2>&1; then
            has_apiserver=1
          else
            echo "kubectl dry-run skipped: no reachable Kubernetes API server (expected in CI)."
          fi
          files=(
            "deploy/helm/settld/values.yaml"
            "deploy/helm/settld/values-minimal.yaml"
            "deploy/helm/settld/values-prod-example.yaml"
            "deploy/helm/settld/values-prod-receiver-example.yaml"
          )
          for f in "${files[@]}"; do
            echo "render: ${f}"
            out="/tmp/$(basename "${f}").rendered.yaml"
            helm template settld deploy/helm/settld -f "${f}" > "${out}"
            if [[ "${has_apiserver}" -eq 1 ]]; then
              kubectl apply --dry-run=client --validate=false -f "${out}" >/dev/null
            fi
          done

      - name: schema gate (misconfig fails fast)
        run: |
          set -euo pipefail
          if helm template settld deploy/helm/settld --set receiver.enabled=true >/dev/null 2>&1; then
            echo "expected helm template to fail when receiver.enabled=true but required fields are missing" >&2
            exit 1
          fi
