name: python-pypi

on:
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

jobs:
  build_python:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.v.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        id: v
        run: |
          VERSION="$(grep -E '^version = \"' packages/api-sdk-python/pyproject.toml | head -n1 | cut -d'"' -f2)"
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build Python distribution artifacts
        run: |
          set -euo pipefail
          OUT=".artifacts/python"
          rm -rf "$OUT"
          mkdir -p "$OUT"

          python3 -m pip install --disable-pip-version-check --no-input --upgrade build
          export SOURCE_DATE_EPOCH="$(date -u -d '2026-02-02 00:00:00' +%s)"
          export PYTHONDONTWRITEBYTECODE=1
          python3 -m build packages/api-sdk-python --sdist --wheel --outdir "$OUT"

          ls "$OUT"/nooterra_api_sdk_python-${{ steps.v.outputs.version }}.tar.gz >/dev/null
          ls "$OUT"/nooterra_api_sdk_python-${{ steps.v.outputs.version }}-*.whl >/dev/null
          (cd "$OUT" && sha256sum nooterra_api_sdk_python-*.whl nooterra_api_sdk_python-*.tar.gz | tee python-SHA256SUMS)

      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-pypi-artifacts-${{ steps.v.outputs.version }}
          path: .artifacts/python

  publish_pypi:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build_python]
    environment:
      name: pypi
      url: https://pypi.org/project/nooterra-api-sdk-python/
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v8
        with:
          name: python-pypi-artifacts-${{ needs.build_python.outputs.version }}
          path: .artifacts/python

      - name: Assert PyPI artifacts exist
        run: |
          set -euo pipefail
          VERSION="${{ needs.build_python.outputs.version }}"
          ls -la .artifacts/python
          ls .artifacts/python/nooterra_api_sdk_python-${VERSION}.tar.gz >/dev/null
          ls .artifacts/python/nooterra_api_sdk_python-${VERSION}-*.whl >/dev/null
          test -f .artifacts/python/python-SHA256SUMS

      - name: Prepare publish-only dist directory
        run: |
          set -euo pipefail
          rm -rf .artifacts/python-publish
          mkdir -p .artifacts/python-publish
          cp .artifacts/python/*.whl .artifacts/python/*.tar.gz .artifacts/python-publish/
          ls -la .artifacts/python-publish

      - name: Publish to PyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: .artifacts/python-publish
          skip-existing: true
