name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 0.3.1)"
        required: true

permissions:
  actions: read
  contents: write
  packages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  require_tests_release_gates:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      actions: read
      contents: read
    steps:
      - name: Require green release gates from tests.yml for release commit
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;
            const requiredJobNames = [
              "noo_44_47_48_regressions",
              "kernel_v0_ship_gate",
              "production_cutover_gate",
              "offline_verification_parity_gate"
            ];

            const runs = await github.paginate(
              github.rest.actions.listWorkflowRunsForRepo,
              {
                owner,
                repo,
                branch: "main",
                event: "push",
                status: "completed",
                per_page: 100
              }
            );
            const testsRuns = runs.filter(
              (run) => run.path === ".github/workflows/tests.yml" && run.head_sha === sha
            );

            if (!testsRuns.length) {
              core.setFailed(
                `No completed tests.yml push run on main found for commit ${sha}. Release is blocked until main release gates run.`
              );
              return;
            }

            const passingRun = testsRuns.find((run) => run.conclusion === "success");
            if (!passingRun) {
              core.setFailed(
                `Found tests.yml run(s) for ${sha}, but none concluded success. Release is blocked.`
              );
              return;
            }

            const jobs = await github.paginate(
              github.rest.actions.listJobsForWorkflowRun,
              {
                owner,
                repo,
                run_id: passingRun.id,
                per_page: 100
              }
            );

            const missingJobs = [];
            const failedJobs = [];
            for (const requiredJobName of requiredJobNames) {
              const gateJob = jobs.find((job) => job.name === requiredJobName);
              if (!gateJob) {
                missingJobs.push(requiredJobName);
                continue;
              }

              if (gateJob.conclusion !== "success") {
                failedJobs.push(`${requiredJobName}=${gateJob.conclusion || "unknown"}`);
              }
            }

            if (missingJobs.length || failedJobs.length) {
              const details = [];
              if (missingJobs.length) details.push(`missing: ${missingJobs.join(", ")}`);
              if (failedJobs.length) details.push(`not-success: ${failedJobs.join(", ")}`);
              core.setFailed(
                `Release gates failed for ${sha}: ${details.join("; ")} in ${passingRun.html_url}.`
              );
              return;
            }

            core.info(
              `Validated release gates (${requiredJobNames.join(", ")})=success in ${passingRun.html_url}`
            );

  release_gate:
    needs: [require_tests_release_gates]
    runs-on: ubuntu-latest
    timeout-minutes: 45
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 5432:5432
    env:
      DATABASE_URL: postgres://postgres:test@127.0.0.1:5432/postgres
      RESTORE_DATABASE_URL: postgres://postgres:test@127.0.0.1:5432/postgres
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        run: npm ci

      - name: Runtime import smoke
        run: npm run -s test:ci:runtime-import-smoke

      - name: Secret hygiene guard
        run: npm run -s test:ci:secret-hygiene

      - name: Start Settld API (pg mode)
        run: |
          set -euo pipefail
          STORE=pg \
          NODE_ENV=production \
          DATABASE_URL="${DATABASE_URL}" \
          PROXY_PG_SCHEMA="release_gate_ci" \
          PROXY_MIGRATE_ON_STARTUP=1 \
          PROXY_OPS_TOKENS="ops_ci:ops_read,ops_write,finance_read,finance_write,audit_read" \
          PROXY_FINANCE_RECONCILE_ENABLED=1 \
          PROXY_MONEY_RAIL_RECONCILE_ENABLED=1 \
          PORT=3000 \
          node src/api/server.js &
          echo $! > /tmp/settld_pid

      - name: Wait for readiness
        run: |
          set -euo pipefail
          for i in $(seq 1 60); do
            if curl -fsS "http://127.0.0.1:3000/healthz" >/dev/null; then exit 0; fi
            sleep 1
          done
          echo "server did not become ready" >&2
          exit 1

      - name: Generate ephemeral signing key
        run: |
          set -euo pipefail
          openssl genpkey -algorithm Ed25519 -out /tmp/ops-ed25519.pem
          chmod 600 /tmp/ops-ed25519.pem

      - name: Run hosted baseline evidence gate (backup/restore required)
        run: |
          set -euo pipefail
          npm run -s ops:hosted-baseline:evidence -- \
            --base-url http://127.0.0.1:3000 \
            --tenant-id tenant_default \
            --ops-token ops_ci \
            --environment release-gate \
            --run-backup-restore true \
            --require-backup-restore true \
            --database-url "${DATABASE_URL}" \
            --restore-database-url "${RESTORE_DATABASE_URL}" \
            --backup-restore-jobs 1 \
            --signing-key-file /tmp/ops-ed25519.pem \
            --signature-key-id ops_ci_k1 \
            --out artifacts/ops/hosted-baseline-release-gate.json

      - name: Enforce Kernel v0 launch gate checklist
        run: npm run -s test:ops:kernel-v0-launch-gate -- --mode prepublish

      - name: Run test suite
        run: npm test

      - name: Assert OpenAPI has no drift
        run: |
          set -euo pipefail
          npm run -s openapi:write
          git diff --exit-code -- openapi/settld.openapi.json

      - name: Run SDK smoke tests (Node + Python)
        run: |
          set -euo pipefail
          npm run -s sdk:smoke
          npm run -s sdk:smoke:py

      - name: Run CLI pack smoke
        run: npm run -s test:cli:pack-smoke

      - name: Run billing smoke gate (staging)
        env:
          SETTLD_BASE_URL: ${{ secrets.SETTLD_STAGING_BASE_URL }}
          PROXY_OPS_TOKEN: ${{ secrets.SETTLD_STAGING_OPS_TOKEN }}
          SETTLD_TENANT_ID: tenant_release_${{ github.run_id }}
        run: |
          set -euo pipefail
          if npm run -s dev:billing:smoke:prod | tee billing-smoke-prod.log; then
            jq -n \
              --arg checkedAt "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
              --arg tenant "${SETTLD_TENANT_ID:-}" \
              '{ok:true, checkedAt:$checkedAt, tenant:$tenant}' > billing-smoke-status.json
          else
            status=$?
            jq -n \
              --arg checkedAt "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
              --arg tenant "${SETTLD_TENANT_ID:-}" \
              --argjson exitCode "$status" \
              '{ok:false, checkedAt:$checkedAt, tenant:$tenant, exitCode:$exitCode}' > billing-smoke-status.json
            exit "$status"
          fi

      - name: Upload billing smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: billing-smoke-${{ github.run_id }}
          path: |
            billing-smoke-prod.log
            billing-smoke-status.json
          if-no-files-found: warn

      - name: Upload release gate deploy-safety artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-deploy-safety-${{ github.run_id }}
          path: |
            artifacts/ops/hosted-baseline-release-gate.json
          if-no-files-found: warn

      - name: Stop server
        if: always()
        run: |
          set -euo pipefail
          if [[ -f /tmp/settld_pid ]]; then kill "$(cat /tmp/settld_pid)" || true; fi

  release_promotion_guard:
    needs: [require_tests_release_gates, release_gate]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Resolve upstream gate workflow runs for this release commit
        id: upstream
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;
            const runs = await github.paginate(
              github.rest.actions.listWorkflowRunsForRepo,
              {
                owner,
                repo,
                status: "completed",
                per_page: 100
              }
            );
            const testsRun = runs.find((run) =>
              run.path === ".github/workflows/tests.yml" &&
              run.event === "push" &&
              run.head_sha === sha &&
              run.conclusion === "success"
            );
            if (!testsRun) {
              core.setFailed(`No successful tests.yml run found for commit ${sha}.`);
              return;
            }
            const goLiveRun = runs.find((run) =>
              run.path === ".github/workflows/go-live-gate.yml" &&
              run.event === "workflow_dispatch" &&
              run.head_sha === sha &&
              run.conclusion === "success"
            );
            if (!goLiveRun) {
              core.setFailed(
                `No successful go-live-gate.yml workflow_dispatch run found for commit ${sha}.`
              );
              return;
            }
            core.setOutput("tests_run_id", String(testsRun.id));
            core.setOutput("go_live_run_id", String(goLiveRun.id));
            core.info(`tests.yml run: ${testsRun.id} (${testsRun.html_url})`);
            core.info(`go-live-gate.yml run: ${goLiveRun.id} (${goLiveRun.html_url})`);

      - name: Download tests.yml artifacts (kernel/prod/parity/onboarding gates)
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ github.token }}
          run-id: ${{ steps.upstream.outputs.tests_run_id }}
          path: /tmp/release-upstream/tests

      - name: Download go-live gate artifacts
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ github.token }}
          run-id: ${{ steps.upstream.outputs.go_live_run_id }}
          path: /tmp/release-upstream/go-live

      - name: Download release deploy-safety artifact
        uses: actions/download-artifact@v4
        with:
          name: release-deploy-safety-${{ github.run_id }}
          path: /tmp/release-upstream/release-gate

      - name: Materialize promotion-guard input artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts/gates artifacts/ops
          copy_required() {
            local root="$1"
            local file_name="$2"
            local dest="$3"
            local matches=()
            mapfile -t matches < <(find "$root" -type f -name "$file_name" | sort)
            if [[ "${#matches[@]}" -eq 0 ]]; then
              echo "missing required artifact: $file_name under $root" >&2
              exit 1
            fi
            if [[ "${#matches[@]}" -gt 1 ]]; then
              echo "ambiguous required artifact: $file_name under $root resolved ${#matches[@]} files" >&2
              printf '%s\n' "${matches[@]}" >&2
              exit 1
            fi
            cp "${matches[0]}" "$dest"
          }
          copy_required "/tmp/release-upstream/tests" "kernel-v0-ship-gate.json" "artifacts/gates/kernel-v0-ship-gate.json"
          copy_required "/tmp/release-upstream/tests" "production-cutover-gate.json" "artifacts/gates/production-cutover-gate.json"
          copy_required "/tmp/release-upstream/tests" "offline-verification-parity-gate.json" "artifacts/gates/offline-verification-parity-gate.json"
          copy_required "/tmp/release-upstream/tests" "onboarding-host-success-gate.json" "artifacts/gates/onboarding-host-success-gate.json"
          copy_required "/tmp/release-upstream/go-live" "s13-go-live-gate.json" "artifacts/gates/s13-go-live-gate.json"
          copy_required "/tmp/release-upstream/go-live" "s13-launch-cutover-packet.json" "artifacts/gates/s13-launch-cutover-packet.json"
          copy_required "/tmp/release-upstream/release-gate" "hosted-baseline-release-gate.json" "artifacts/ops/hosted-baseline-release-gate.json"
          ls -la artifacts/gates
          ls -la artifacts/ops

      - name: Run release promotion guard (NOO-65)
        run: |
          set -euo pipefail
          npm run -s test:ops:release-promotion-guard -- \
            --kernel-gate artifacts/gates/kernel-v0-ship-gate.json \
            --production-gate artifacts/gates/production-cutover-gate.json \
            --offline-parity-gate artifacts/gates/offline-verification-parity-gate.json \
            --onboarding-host-success-gate artifacts/gates/onboarding-host-success-gate.json \
            --go-live-gate artifacts/gates/s13-go-live-gate.json \
            --launch-packet artifacts/gates/s13-launch-cutover-packet.json \
            --baseline-evidence artifacts/ops/hosted-baseline-release-gate.json \
            --promotion-ref "${{ github.sha }}"

      - name: Upload release promotion guard artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-promotion-guard-${{ github.run_id }}
          path: |
            artifacts/gates/release-promotion-guard.json
            artifacts/gates/kernel-v0-ship-gate.json
            artifacts/gates/production-cutover-gate.json
            artifacts/gates/offline-verification-parity-gate.json
            artifacts/gates/onboarding-host-success-gate.json
            artifacts/gates/s13-go-live-gate.json
            artifacts/gates/s13-launch-cutover-packet.json
            artifacts/ops/hosted-baseline-release-gate.json
          if-no-files-found: error

  docker_image:
    needs: [release_gate, release_promotion_guard]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      IMAGE_REPOSITORY: ghcr.io/${{ github.repository }}
    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.IMAGE_REPOSITORY }}:${{ steps.v.outputs.version }}
            ${{ env.IMAGE_REPOSITORY }}:sha-${{ github.sha }}
          build-args: |
            SETTLD_VERSION=${{ steps.v.outputs.version }}
            GIT_SHA=${{ github.sha }}

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.IMAGE_REPOSITORY }}:${{ steps.v.outputs.version }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.v.outputs.version }}
          path: sbom.spdx.json

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign image (keyless)
        run: cosign sign --yes ${{ env.IMAGE_REPOSITORY }}:${{ steps.v.outputs.version }}

  helm_chart:
    needs: [release_gate, release_promotion_guard]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      CHART_REGISTRY: ghcr.io/${{ github.repository_owner }}/charts
    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Helm registry login (GHCR)
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Package chart
        id: package_chart
        run: |
          set -euo pipefail
          helm package deploy/helm/settld --version "${{ steps.v.outputs.version }}" --app-version "${{ steps.v.outputs.version }}" --destination /tmp
          CHART_TGZ="/tmp/settld-helm-chart-${{ steps.v.outputs.version }}.tgz"
          mv "/tmp/settld-${{ steps.v.outputs.version }}.tgz" "$CHART_TGZ"
          echo "chart_tgz=$CHART_TGZ" >> "$GITHUB_OUTPUT"
          ls -la "$CHART_TGZ"

      - name: Push chart (OCI)
        run: |
          set -euo pipefail
          helm push "${{ steps.package_chart.outputs.chart_tgz }}" "oci://${{ env.CHART_REGISTRY }}"

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Docker login (GHCR for cosign)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign chart (keyless)
        id: sign_chart
        continue-on-error: ${{ github.event_name == 'workflow_dispatch' }}
        run: cosign sign --yes "${{ env.CHART_REGISTRY }}/settld:${{ steps.v.outputs.version }}"

      - name: Enforce chart signing on tag releases
        if: ${{ steps.sign_chart.outcome == 'failure' && github.event_name != 'workflow_dispatch' }}
        run: |
          echo "chart signing failed on tag release; blocking release." >&2
          exit 1

      - name: Upload chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart-${{ steps.v.outputs.version }}
          path: ${{ steps.package_chart.outputs.chart_tgz }}

  npm_packages:
    needs: [release_gate, release_promotion_guard]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci

      - name: Stamp npm package versions for release artifacts
        run: |
          set -euo pipefail
          VERSION="${{ steps.v.outputs.version }}"
          npm pkg set version="$VERSION" --silent
          npm pkg set version="$VERSION" --prefix packages/api-sdk --silent
          npm pkg set version="$VERSION" --prefix packages/provider-kit --silent
          npm pkg set version="$VERSION" --prefix packages/create-settld-paid-tool --silent
          printf '%s\n' "$VERSION" > SETTLD_VERSION

      - name: Pack npm artifacts (no publish)
        run: |
          set -euo pipefail
          OUT="/tmp/npm-artifacts"
          rm -rf "$OUT"
          mkdir -p "$OUT"

          # Best-effort reproducibility: normalize mtimes before packing.
          find packages -maxdepth 2 -type f -name "package.json" -print0 | while IFS= read -r -d '' pkg; do
            d="$(dirname "$pkg")"
            find "$d" -type f -print0 | xargs -0 -r touch -h -t 202602020000.00
          done

          (cd packages/api-sdk && npm pack --silent --pack-destination "$OUT")
          (cd packages/artifact-produce && npm pack --silent --pack-destination "$OUT")
          (cd packages/artifact-verify && npm pack --silent --pack-destination "$OUT")
          (cd packages/executor-sdk && npm pack --silent --pack-destination "$OUT")
          (cd packages/magic-link-cli && npm pack --silent --pack-destination "$OUT")
          (cd packages/metering-adapter-sdk && npm pack --silent --pack-destination "$OUT")
          (cd packages/provider-kit && npm pack --silent --pack-destination "$OUT")
          (cd packages/create-settld-paid-tool && npm pack --silent --pack-destination "$OUT")
          (cd . && npm pack --silent --pack-destination "$OUT")

          (cd "$OUT" && ls -la && sha256sum *.tgz | tee npm-SHA256SUMS)

      - name: Upload npm artifacts
        uses: actions/upload-artifact@v4
        with:
          name: npm-artifacts-${{ steps.v.outputs.version }}
          path: /tmp/npm-artifacts

  npm_publish:
    needs: [npm_packages]
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Gate npm publish on NPM_TOKEN
        id: npm_publish_guard
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [[ -z "${NPM_TOKEN}" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "NPM_TOKEN is not configured; skipping npm publish and registry smoke."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Compute version
        if: ${{ steps.npm_publish_guard.outputs.skip != 'true' }}
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-node@v4
        if: ${{ steps.npm_publish_guard.outputs.skip != 'true' }}
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - if: ${{ steps.npm_publish_guard.outputs.skip != 'true' }}
        run: npm ci

      - name: Decide scoped npm publish mode
        if: ${{ steps.npm_publish_guard.outputs.skip != 'true' }}
        id: npm_scope_mode
        env:
          NPM_SCOPE_SETTLD_PUBLISH: ${{ secrets.NPM_SCOPE_SETTLD_PUBLISH }}
        run: |
          if [[ "${NPM_SCOPE_SETTLD_PUBLISH}" == "true" ]]; then
            echo "provider_kit=true" >> "$GITHUB_OUTPUT"
            echo "Scoped npm publish enabled for @settld/provider-kit."
          else
            echo "provider_kit=false" >> "$GITHUB_OUTPUT"
            echo "Scoped npm publish disabled; @settld/provider-kit will be skipped."
          fi

      - name: Stamp npm package versions for publish
        if: ${{ steps.npm_publish_guard.outputs.skip != 'true' }}
        run: |
          set -euo pipefail
          VERSION="${{ steps.v.outputs.version }}"
          npm pkg set version="$VERSION" --silent
          npm pkg set version="$VERSION" --prefix packages/api-sdk --silent
          npm pkg set version="$VERSION" --prefix packages/provider-kit --silent
          npm pkg set version="$VERSION" --prefix packages/create-settld-paid-tool --silent
          printf '%s\n' "$VERSION" > SETTLD_VERSION

      - name: Publish npm packages (CLI + JS SDK)
        if: ${{ steps.npm_publish_guard.outputs.skip != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${{ steps.v.outputs.version }}"
          publish_if_missing() {
            local dir="$1"
            local name
            name="$(node -p "require('./${dir}/package.json').name")"
            if npm view "${name}@${VERSION}" version >/dev/null 2>&1; then
              echo "${name}@${VERSION} already exists; skipping publish."
              return 0
            fi
            echo "publishing ${name}@${VERSION}"
            (cd "${dir}" && npm publish --access public --provenance)
          }
          publish_if_missing "."
          publish_if_missing "packages/api-sdk"
          if [[ "${{ steps.npm_scope_mode.outputs.provider_kit }}" == "true" ]]; then
            publish_if_missing "packages/provider-kit"
          else
            echo "Skipping scoped publish for @settld/provider-kit (NPM_SCOPE_SETTLD_PUBLISH != true)."
          fi
          publish_if_missing "packages/create-settld-paid-tool"

      - name: Smoke npm registry install (npx, no-clone)
        if: ${{ steps.npm_publish_guard.outputs.skip != 'true' }}
        run: |
          set -euo pipefail
          VERSION="${{ steps.v.outputs.version }}"
          SMOKE_DIR="$(mktemp -d)"
          trap 'rm -rf "$SMOKE_DIR"' EXIT

          wait_for_cmd() {
            local cmd="$1"
            local attempts=36
            for i in $(seq 1 "$attempts"); do
              if (cd "$SMOKE_DIR" && bash -lc "$cmd"); then
                return 0
              fi
              if [ "$i" -eq "$attempts" ]; then
                echo "registry smoke command failed after ${attempts} attempts: $cmd" >&2
                return 1
              fi
              sleep 10
            done
          }

          wait_for_cmd "npm view settld@${VERSION} version > /tmp/settld-npm-view-version.txt"
          test "$(tr -d '\r\n' < /tmp/settld-npm-view-version.txt)" = "${VERSION}"

          if [[ "${PROVIDER_KIT_EXPECTED}" == "true" ]]; then
            wait_for_cmd "npm view @settld/provider-kit@${VERSION} version > /tmp/provider-kit-npm-view-version.txt"
            test "$(tr -d '\r\n' < /tmp/provider-kit-npm-view-version.txt)" = "${VERSION}"
          else
            echo "Skipping provider-kit npm view smoke (scoped publish disabled)."
          fi

          wait_for_cmd "npm view create-settld-paid-tool@${VERSION} version > /tmp/create-settld-paid-tool-npm-view-version.txt"
          test "$(tr -d '\r\n' < /tmp/create-settld-paid-tool-npm-view-version.txt)" = "${VERSION}"

          wait_for_cmd "npm exec --yes --package settld@${VERSION} -- settld --version > /tmp/settld-npx-version.txt"
          test "$(tr -d '\r\n' < /tmp/settld-npx-version.txt)" = "${VERSION}"

          wait_for_cmd "npm exec --yes --package settld@${VERSION} -- settld conformance kernel:list > /tmp/settld-kernel-cases.txt"
          test -s /tmp/settld-kernel-cases.txt

          (cd "$SMOKE_DIR" && npm exec --yes --package settld@${VERSION} -- settld --help >/tmp/settld-help.txt 2>&1)
          grep -q "settld closepack verify" /tmp/settld-help.txt

          STARTER_DIR="/tmp/settld-registry-starter"
          rm -rf "$STARTER_DIR"
          (cd "$SMOKE_DIR" && npm exec --yes --package settld@${VERSION} -- settld init capability smoke-cap --out "$STARTER_DIR")
          test -f "$STARTER_DIR/manifest.json"
          test -f "$STARTER_DIR/manifest.sig.json"
          test -f "$STARTER_DIR/scripts/kernel-prove.mjs"
          grep -q 'settld-api-sdk' "$STARTER_DIR/package.json"

          wait_for_cmd "npm exec --yes --package create-settld-paid-tool@${VERSION} -- create-settld-paid-tool --help > /tmp/create-settld-paid-tool-help.txt"
          grep -q 'create-settld-paid-tool \[directory\]' /tmp/create-settld-paid-tool-help.txt

          PAID_TOOL_DIR="/tmp/settld-registry-paid-tool"
          rm -rf "$PAID_TOOL_DIR"
          wait_for_cmd "cd \"$SMOKE_DIR\" && npm exec --yes --package create-settld-paid-tool@${VERSION} -- create-settld-paid-tool \"$PAID_TOOL_DIR\""
          test -f "$PAID_TOOL_DIR/package.json"
          test -f "$PAID_TOOL_DIR/server.mjs"
          grep -q '@settld/provider-kit' "$PAID_TOOL_DIR/package.json"

          node -e '
            const fs = require("node:fs");
            const providerKitExpected = process.env.PROVIDER_KIT_EXPECTED === "true";
            const commands = [
              { cmd: "npm view settld@<version> version", ok: true }
            ];
            if (providerKitExpected) {
              commands.push({ cmd: "npm view @settld/provider-kit@<version> version", ok: true });
            }
            commands.push(
              { cmd: "npm view create-settld-paid-tool@<version> version", ok: true },
              { cmd: "npm exec --yes --package settld@<version> -- settld --version", ok: true },
              { cmd: "npm exec --yes --package settld@<version> -- settld conformance kernel:list", ok: true },
              { cmd: "npm exec --yes --package settld@<version> -- settld --help (contains closepack verify)", ok: true },
              { cmd: "npm exec --yes --package settld@<version> -- settld init capability smoke-cap --out /tmp/settld-registry-starter", ok: true },
              { cmd: "npm exec --yes --package create-settld-paid-tool@<version> -- create-settld-paid-tool --help", ok: true },
              { cmd: "npm exec --yes --package create-settld-paid-tool@<version> -- create-settld-paid-tool /tmp/settld-registry-paid-tool", ok: true }
            );
            const payload = {
              schemaVersion: "NpmPostpublishSmoke.v1",
              package: "settld",
              version: process.env.VERSION || null,
              checkedAt: new Date().toISOString(),
              commands
            };
            fs.writeFileSync("/tmp/npm-postpublish-smoke.json", JSON.stringify(payload, null, 2));
          '
        env:
          VERSION: ${{ steps.v.outputs.version }}
          PROVIDER_KIT_EXPECTED: ${{ steps.npm_scope_mode.outputs.provider_kit }}

      - name: Upload npm postpublish smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-postpublish-smoke-${{ steps.v.outputs.version }}
          path: |
            /tmp/settld-npm-view-version.txt
            /tmp/provider-kit-npm-view-version.txt
            /tmp/create-settld-paid-tool-npm-view-version.txt
            /tmp/settld-npx-version.txt
            /tmp/settld-kernel-cases.txt
            /tmp/settld-help.txt
            /tmp/create-settld-paid-tool-help.txt
            /tmp/npm-postpublish-smoke.json
          if-no-files-found: warn

  python_package:
    needs: [release_gate, release_promotion_guard]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Stamp Python package version for release artifacts
        run: |
          set -euo pipefail
          VERSION="${{ steps.v.outputs.version }}"
          sed -E -i "s/^version = \".+\"$/version = \"${VERSION}\"/" packages/api-sdk-python/pyproject.toml
          grep -n '^version = ' packages/api-sdk-python/pyproject.toml

      - name: Build Python distribution artifacts (no publish)
        run: |
          set -euo pipefail
          OUT=".artifacts/python"
          rm -rf "$OUT"
          mkdir -p "$OUT"

          python3 -m pip install --disable-pip-version-check --no-input --upgrade build
          export SOURCE_DATE_EPOCH="$(date -u -d '2026-02-02 00:00:00' +%s)"
          export PYTHONDONTWRITEBYTECODE=1
          python3 -m build packages/api-sdk-python --sdist --wheel --outdir "$OUT"

          ls "$OUT"/settld_api_sdk_python-*.whl >/dev/null
          ls "$OUT"/settld_api_sdk_python-*.tar.gz >/dev/null
          ls "$OUT"/settld_api_sdk_python-${{ steps.v.outputs.version }}.tar.gz >/dev/null
          ls "$OUT"/settld_api_sdk_python-${{ steps.v.outputs.version }}-*.whl >/dev/null
          (cd "$OUT" && sha256sum settld_api_sdk_python-*.whl settld_api_sdk_python-*.tar.gz | tee python-SHA256SUMS)

      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-artifacts-${{ steps.v.outputs.version }}
          path: .artifacts/python

  python_publish:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [python_package]
    environment:
      name: pypi
      url: https://pypi.org/project/settld-api-sdk-python/
    permissions:
      id-token: write
    steps:
      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - uses: actions/download-artifact@v4
        with:
          name: python-artifacts-${{ steps.v.outputs.version }}
          path: .artifacts/python

      - name: Assert Python release artifacts match tag version
        run: |
          set -euo pipefail
          VERSION="${{ steps.v.outputs.version }}"
          ls -la .artifacts/python
          ls .artifacts/python/settld_api_sdk_python-${VERSION}.tar.gz >/dev/null
          ls .artifacts/python/settld_api_sdk_python-${VERSION}-*.whl >/dev/null
          test -f .artifacts/python/python-SHA256SUMS

      - name: Prepare publish-only dist directory
        run: |
          set -euo pipefail
          rm -rf .artifacts/python-publish
          mkdir -p .artifacts/python-publish
          cp .artifacts/python/*.whl .artifacts/python/*.tar.gz .artifacts/python-publish/
          ls -la .artifacts/python-publish

      - name: Publish Python package to PyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: .artifacts/python-publish
          skip-existing: true

      - name: Smoke PyPI install (no-clone)
        run: |
          set -euo pipefail
          VERSION="${{ steps.v.outputs.version }}"
          python3 -m pip install --disable-pip-version-check --no-input --upgrade pip
          for i in $(seq 1 18); do
            if python3 -m pip install --disable-pip-version-check --no-input --no-deps "settld-api-sdk-python==${VERSION}"; then
              break
            fi
            if [ "$i" -eq 18 ]; then
              echo "PyPI smoke install failed for settld-api-sdk-python==${VERSION}" >&2
              exit 1
            fi
            sleep 10
          done
          python3 - <<'PY'
          from settld_api_sdk.client import SettldClient
          print(SettldClient.__name__)
          PY

  conformance_pack:
    needs: [release_gate, release_promotion_guard]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build conformance pack tarball
        run: |
          set -euo pipefail
          OUT="/tmp/conformance-artifacts"
          rm -rf "$OUT"
          mkdir -p "$OUT"

          rm -rf /tmp/conformance-v1
          mkdir -p /tmp/conformance-v1
          cp -a conformance/v1/. /tmp/conformance-v1/

          tar --sort=name --mtime='2026-02-02 00:00:00Z' --owner=0 --group=0 --numeric-owner -cf "$OUT/conformance-v1.tar" -C /tmp conformance-v1
          gzip -n -9 -c "$OUT/conformance-v1.tar" > "$OUT/conformance-v1.tar.gz"
          rm -f "$OUT/conformance-v1.tar"
          (cd "$OUT" && sha256sum conformance-v1.tar.gz | tee conformance-v1-SHA256SUMS)

      - name: Upload conformance pack
        uses: actions/upload-artifact@v4
        with:
          name: conformance-pack-${{ steps.v.outputs.version }}
          path: /tmp/conformance-artifacts

  audit_packet:
    needs: [release_gate, release_promotion_guard]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build audit packet zip
        run: |
          set -euo pipefail
          OUT="/tmp/audit-artifacts"
          rm -rf "$OUT"
          mkdir -p "$OUT"

          node scripts/audit/build-audit-packet.mjs --out "$OUT" --packet-version v1
          (cd "$OUT" && sha256sum settld-audit-packet-v1.zip | tee settld-audit-packet-v1.zip.sha256)

      - name: Upload audit packet
        uses: actions/upload-artifact@v4
        with:
          name: audit-packet-${{ steps.v.outputs.version }}
          path: /tmp/audit-artifacts

  github_release:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [docker_image, helm_chart, npm_packages, npm_publish, python_publish, conformance_pack, audit_packet]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
            TAG="v${VERSION}"
          else
            TAG="${GITHUB_REF_NAME}"
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Download npm artifacts
        uses: actions/download-artifact@v4
        with:
          name: npm-artifacts-${{ steps.v.outputs.version }}
          path: /tmp/release-artifacts/npm-artifacts

      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-artifacts-${{ steps.v.outputs.version }}
          path: /tmp/release-artifacts/python-artifacts

      - name: Download conformance pack
        uses: actions/download-artifact@v4
        with:
          name: conformance-pack-${{ steps.v.outputs.version }}
          path: /tmp/release-artifacts/conformance-pack

      - name: Download audit packet
        uses: actions/download-artifact@v4
        with:
          name: audit-packet-${{ steps.v.outputs.version }}
          path: /tmp/release-artifacts/audit-packet

      - name: Download Helm chart
        uses: actions/download-artifact@v4
        with:
          name: helm-chart-${{ steps.v.outputs.version }}
          path: /tmp/release-artifacts/helm-chart

      - name: Download SBOM artifact
        uses: actions/download-artifact@v4
        with:
          name: sbom-${{ steps.v.outputs.version }}
          path: /tmp/release-artifacts/sbom

      - name: Download release promotion guard artifact
        uses: actions/download-artifact@v4
        with:
          name: release-promotion-guard-${{ github.run_id }}
          path: /tmp/release-artifacts/release-promotion-guard

      - name: Prepare asset directory
        run: |
          set -euo pipefail
          mkdir -p /tmp/release-assets
          find /tmp/release-artifacts -type f -print0 | while IFS= read -r -d '' f; do
            cp "$f" /tmp/release-assets/
          done
          ls -la /tmp/release-assets

      - name: Assert required release assets exist
        run: |
          set -euo pipefail
          ls -la /tmp/release-assets
          test -f /tmp/release-assets/conformance-v1.tar.gz
          test -f /tmp/release-assets/conformance-v1-SHA256SUMS
          test -f /tmp/release-assets/settld-audit-packet-v1.zip
          test -f /tmp/release-assets/settld-audit-packet-v1.zip.sha256
          test -f /tmp/release-assets/release-promotion-guard.json
          # npm tgz artifacts + checksums
          ls /tmp/release-assets/settld-api-sdk-*.tgz >/dev/null
          ls /tmp/release-assets/settld-artifact-produce-*.tgz >/dev/null
          ls /tmp/release-assets/settld-executor-sdk-*.tgz >/dev/null
          ls /tmp/release-assets/settld-artifact-verify-*.tgz >/dev/null
          ls /tmp/release-assets/settld-magic-link-cli-*.tgz >/dev/null
          ls /tmp/release-assets/settld-metering-adapter-sdk-*.tgz >/dev/null
          ls /tmp/release-assets/settld-*.tgz >/dev/null
          test -f /tmp/release-assets/npm-SHA256SUMS
          # python distribution artifacts + checksums
          ls /tmp/release-assets/settld_api_sdk_python-*.whl >/dev/null
          ls /tmp/release-assets/settld_api_sdk_python-*.tar.gz >/dev/null
          test -f /tmp/release-assets/python-SHA256SUMS

      - name: Gate ReleaseIndex signing key
        id: release_signing_guard
        env:
          SETTLD_RELEASE_SIGNING_PRIVATE_KEY_PEM: ${{ secrets.SETTLD_RELEASE_SIGNING_PRIVATE_KEY_PEM }}
        run: |
          set -euo pipefail
          if [[ -n "${SETTLD_RELEASE_SIGNING_PRIVATE_KEY_PEM}" ]]; then
            echo "has_key=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_key=false" >> "$GITHUB_OUTPUT"
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "SETTLD_RELEASE_SIGNING_PRIVATE_KEY_PEM is required for tag releases." >&2
            exit 1
          fi
          echo "workflow_dispatch without release signing key; skipping ReleaseIndex signature steps."

      - name: Generate ReleaseIndex.v1 (signed release manifest)
        if: ${{ steps.release_signing_guard.outputs.has_key == 'true' }}
        run: |
          set -euo pipefail
          node scripts/release/generate-release-index.mjs --dir /tmp/release-assets --tag "${{ steps.v.outputs.tag }}" --version "${{ steps.v.outputs.version }}" --commit "${{ github.sha }}"

      - name: Sign ReleaseIndex.v1
        if: ${{ steps.release_signing_guard.outputs.has_key == 'true' }}
        env:
          SETTLD_RELEASE_SIGNING_PRIVATE_KEY_PEM: ${{ secrets.SETTLD_RELEASE_SIGNING_PRIVATE_KEY_PEM }}
        run: |
          set -euo pipefail
          node scripts/release/sign-release-index.mjs --index /tmp/release-assets/release_index_v1.json --out /tmp/release-assets/release_index_v1.sig --private-key-env SETTLD_RELEASE_SIGNING_PRIVATE_KEY_PEM

      - name: Validate release assets (checksums + contents + ReleaseIndex signature)
        if: ${{ steps.release_signing_guard.outputs.has_key == 'true' }}
        run: node scripts/release/validate-release-assets.mjs --dir /tmp/release-assets --release-trust trust/release-trust.json

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.v.outputs.tag }}
          name: ${{ steps.v.outputs.tag }}
          files: /tmp/release-assets/*
