name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 0.3.1)"
        required: true

permissions:
  contents: write
  packages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release_gate:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        run: npm ci

      - name: Enforce Kernel v0 launch gate checklist
        run: npm run -s test:ops:kernel-v0-launch-gate -- --mode prepublish

      - name: Run test suite
        run: npm test

      - name: Assert OpenAPI has no drift
        run: |
          set -euo pipefail
          npm run -s openapi:write
          git diff --exit-code -- openapi/settld.openapi.json

      - name: Run SDK smoke tests (Node + Python)
        run: |
          set -euo pipefail
          npm run -s sdk:smoke
          npm run -s sdk:smoke:py

      - name: Run CLI pack smoke
        run: npm run -s test:cli:pack-smoke

      - name: Run billing smoke gate (staging)
        env:
          SETTLD_BASE_URL: ${{ secrets.SETTLD_STAGING_BASE_URL }}
          PROXY_OPS_TOKEN: ${{ secrets.SETTLD_STAGING_OPS_TOKEN }}
          PROXY_BILLING_STRIPE_SECRET_KEY: ${{ secrets.SETTLD_STAGING_STRIPE_SECRET_KEY }}
          SETTLD_TENANT_ID: tenant_release_${{ github.run_id }}
        run: |
          set -euo pipefail
          if npm run -s dev:billing:smoke:prod | tee billing-smoke-prod.log; then
            jq -n \
              --arg checkedAt "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
              --arg tenant "${SETTLD_TENANT_ID:-}" \
              '{ok:true, checkedAt:$checkedAt, tenant:$tenant}' > billing-smoke-status.json
          else
            status=$?
            jq -n \
              --arg checkedAt "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
              --arg tenant "${SETTLD_TENANT_ID:-}" \
              --argjson exitCode "$status" \
              '{ok:false, checkedAt:$checkedAt, tenant:$tenant, exitCode:$exitCode}' > billing-smoke-status.json
            exit "$status"
          fi

      - name: Upload billing smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: billing-smoke-${{ github.run_id }}
          path: |
            billing-smoke-prod.log
            billing-smoke-status.json
          if-no-files-found: warn

  docker_image:
    needs: [release_gate]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      IMAGE_REPOSITORY: ghcr.io/${{ github.repository }}
    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.IMAGE_REPOSITORY }}:${{ steps.v.outputs.version }}
            ${{ env.IMAGE_REPOSITORY }}:sha-${{ github.sha }}
          build-args: |
            SETTLD_VERSION=${{ steps.v.outputs.version }}
            GIT_SHA=${{ github.sha }}

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.IMAGE_REPOSITORY }}:${{ steps.v.outputs.version }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.v.outputs.version }}
          path: sbom.spdx.json

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign image (keyless)
        run: cosign sign --yes ${{ env.IMAGE_REPOSITORY }}:${{ steps.v.outputs.version }}

  helm_chart:
    needs: [release_gate]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      CHART_REGISTRY: ghcr.io/${{ github.repository_owner }}/charts
    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Helm registry login (GHCR)
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Package chart
        run: |
          set -euo pipefail
          helm package deploy/helm/settld --version "${{ steps.v.outputs.version }}" --app-version "${{ steps.v.outputs.version }}" --destination /tmp
          ls -la /tmp/*.tgz

      - name: Push chart (OCI)
        run: |
          set -euo pipefail
          helm push /tmp/settld-*.tgz "oci://${{ env.CHART_REGISTRY }}"

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign chart (keyless)
        id: sign_chart
        continue-on-error: ${{ github.event_name == 'workflow_dispatch' }}
        run: cosign sign --yes "${{ env.CHART_REGISTRY }}/settld:${{ steps.v.outputs.version }}"

      - name: Enforce chart signing on tag releases
        if: ${{ steps.sign_chart.outcome == 'failure' && github.event_name != 'workflow_dispatch' }}
        run: |
          echo "chart signing failed on tag release; blocking release." >&2
          exit 1

      - name: Upload chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart-${{ steps.v.outputs.version }}
          path: /tmp/settld-*.tgz

  npm_packages:
    needs: [release_gate]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci

      - name: Pack npm artifacts (no publish)
        run: |
          set -euo pipefail
          OUT="/tmp/npm-artifacts"
          rm -rf "$OUT"
          mkdir -p "$OUT"

          # Best-effort reproducibility: normalize mtimes before packing.
          find packages -maxdepth 2 -type f -name "package.json" -print0 | while IFS= read -r -d '' pkg; do
            d="$(dirname "$pkg")"
            find "$d" -type f -print0 | xargs -0 -r touch -h -t 202602020000.00
          done

          (cd packages/api-sdk && npm pack --silent --pack-destination "$OUT")
          (cd packages/artifact-produce && npm pack --silent --pack-destination "$OUT")
          (cd packages/artifact-verify && npm pack --silent --pack-destination "$OUT")
          (cd packages/executor-sdk && npm pack --silent --pack-destination "$OUT")
          (cd packages/magic-link-cli && npm pack --silent --pack-destination "$OUT")
          (cd packages/metering-adapter-sdk && npm pack --silent --pack-destination "$OUT")
          (cd . && npm pack --silent --pack-destination "$OUT")

          (cd "$OUT" && ls -la && sha256sum *.tgz | tee npm-SHA256SUMS)

      - name: Upload npm artifacts
        uses: actions/upload-artifact@v4
        with:
          name: npm-artifacts-${{ steps.v.outputs.version }}
          path: /tmp/npm-artifacts

  npm_publish:
    needs: [npm_packages]
    if: ${{ secrets.NPM_TOKEN != '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - run: npm ci

      - name: Stamp npm package versions for publish
        run: |
          set -euo pipefail
          VERSION="${{ steps.v.outputs.version }}"
          npm pkg set version="$VERSION" --silent
          npm pkg set version="$VERSION" --prefix packages/api-sdk --silent

      - name: Publish npm packages (CLI + JS SDK)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${{ steps.v.outputs.version }}"
          publish_if_missing() {
            local dir="$1"
            local name
            name="$(node -p "require('./${dir}/package.json').name")"
            if npm view "${name}@${VERSION}" version >/dev/null 2>&1; then
              echo "${name}@${VERSION} already exists; skipping publish."
              return 0
            fi
            echo "publishing ${name}@${VERSION}"
            (cd "${dir}" && npm publish --access public --provenance)
          }
          publish_if_missing "."
          publish_if_missing "packages/api-sdk"

      - name: Smoke npm registry install (npx, no-clone)
        run: |
          set -euo pipefail
          VERSION="${{ steps.v.outputs.version }}"

          wait_for_npx() {
            local cmd="$1"
            local attempts=18
            for i in $(seq 1 "$attempts"); do
              if bash -lc "$cmd"; then
                return 0
              fi
              if [ "$i" -eq "$attempts" ]; then
                echo "registry smoke command failed after ${attempts} attempts: $cmd" >&2
                return 1
              fi
              sleep 10
            done
          }

          wait_for_npx "npx --yes settld@${VERSION} --version > /tmp/settld-npx-version.txt"
          test \"$(tr -d '\r\n' < /tmp/settld-npx-version.txt)\" = "${VERSION}"

          wait_for_npx "npx --yes settld@${VERSION} conformance kernel:list > /tmp/settld-kernel-cases.txt"
          test -s /tmp/settld-kernel-cases.txt

          npx --yes settld@${VERSION} closepack verify --help >/tmp/settld-closepack-help.txt
          test -s /tmp/settld-closepack-help.txt

          STARTER_DIR="/tmp/settld-registry-starter"
          rm -rf "$STARTER_DIR"
          npx --yes settld@${VERSION} init capability smoke-cap --out "$STARTER_DIR"
          test -f "$STARTER_DIR/manifest.json"
          test -f "$STARTER_DIR/manifest.sig.json"
          test -f "$STARTER_DIR/scripts/kernel-prove.mjs"
          grep -q 'settld-api-sdk' "$STARTER_DIR/package.json"

          node -e '
            const fs = require("node:fs");
            const payload = {
              schemaVersion: "NpmPostpublishSmoke.v1",
              package: "settld",
              version: process.env.VERSION || null,
              checkedAt: new Date().toISOString(),
              commands: [
                { cmd: "npx --yes settld@<version> --version", ok: true },
                { cmd: "npx --yes settld@<version> conformance kernel:list", ok: true },
                { cmd: "npx --yes settld@<version> closepack verify --help", ok: true },
                { cmd: "npx --yes settld@<version> init capability smoke-cap --out /tmp/settld-registry-starter", ok: true }
              ]
            };
            fs.writeFileSync("/tmp/npm-postpublish-smoke.json", JSON.stringify(payload, null, 2));
          '
        env:
          VERSION: ${{ steps.v.outputs.version }}

      - name: Upload npm postpublish smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-postpublish-smoke-${{ steps.v.outputs.version }}
          path: |
            /tmp/settld-npx-version.txt
            /tmp/settld-kernel-cases.txt
            /tmp/settld-closepack-help.txt
            /tmp/npm-postpublish-smoke.json
          if-no-files-found: warn

  python_package:
    needs: [release_gate]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build Python distribution artifacts (no publish)
        run: |
          set -euo pipefail
          OUT=".artifacts/python"
          rm -rf "$OUT"
          mkdir -p "$OUT"

          python3 -m pip install --disable-pip-version-check --no-input --upgrade build
          export SOURCE_DATE_EPOCH="$(date -u -d '2026-02-02 00:00:00' +%s)"
          export PYTHONDONTWRITEBYTECODE=1
          python3 -m build packages/api-sdk-python --sdist --wheel --outdir "$OUT"

          ls "$OUT"/settld_api_sdk_python-*.whl >/dev/null
          ls "$OUT"/settld_api_sdk_python-*.tar.gz >/dev/null
          ls "$OUT"/settld_api_sdk_python-${{ steps.v.outputs.version }}.tar.gz >/dev/null
          ls "$OUT"/settld_api_sdk_python-${{ steps.v.outputs.version }}-*.whl >/dev/null
          (cd "$OUT" && sha256sum settld_api_sdk_python-*.whl settld_api_sdk_python-*.tar.gz | tee python-SHA256SUMS)

      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-artifacts-${{ steps.v.outputs.version }}
          path: .artifacts/python

  python_publish:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [python_package]
    environment:
      name: pypi
      url: https://pypi.org/project/settld-api-sdk-python/
    permissions:
      id-token: write
    steps:
      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - uses: actions/download-artifact@v4
        with:
          name: python-artifacts-${{ steps.v.outputs.version }}
          path: .artifacts/python

      - name: Assert Python release artifacts match tag version
        run: |
          set -euo pipefail
          VERSION="${{ steps.v.outputs.version }}"
          ls -la .artifacts/python
          ls .artifacts/python/settld_api_sdk_python-${VERSION}.tar.gz >/dev/null
          ls .artifacts/python/settld_api_sdk_python-${VERSION}-*.whl >/dev/null
          test -f .artifacts/python/python-SHA256SUMS

      - name: Prepare publish-only dist directory
        run: |
          set -euo pipefail
          rm -rf .artifacts/python-publish
          mkdir -p .artifacts/python-publish
          cp .artifacts/python/*.whl .artifacts/python/*.tar.gz .artifacts/python-publish/
          ls -la .artifacts/python-publish

      - name: Publish Python package to PyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: .artifacts/python-publish
          skip-existing: true

      - name: Smoke PyPI install (no-clone)
        run: |
          set -euo pipefail
          VERSION="${{ steps.v.outputs.version }}"
          python3 -m pip install --disable-pip-version-check --no-input --upgrade pip
          for i in $(seq 1 18); do
            if python3 -m pip install --disable-pip-version-check --no-input --no-deps "settld-api-sdk-python==${VERSION}"; then
              break
            fi
            if [ "$i" -eq 18 ]; then
              echo "PyPI smoke install failed for settld-api-sdk-python==${VERSION}" >&2
              exit 1
            fi
            sleep 10
          done
          python3 - <<'PY'
from settld_api_sdk.client import SettldClient
print(SettldClient.__name__)
PY

  conformance_pack:
    needs: [release_gate]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build conformance pack tarball
        run: |
          set -euo pipefail
          OUT="/tmp/conformance-artifacts"
          rm -rf "$OUT"
          mkdir -p "$OUT"

          rm -rf /tmp/conformance-v1
          mkdir -p /tmp/conformance-v1
          cp -a conformance/v1/. /tmp/conformance-v1/

          tar --sort=name --mtime='2026-02-02 00:00:00Z' --owner=0 --group=0 --numeric-owner -cf "$OUT/conformance-v1.tar" -C /tmp conformance-v1
          gzip -n -9 -c "$OUT/conformance-v1.tar" > "$OUT/conformance-v1.tar.gz"
          rm -f "$OUT/conformance-v1.tar"
          (cd "$OUT" && sha256sum conformance-v1.tar.gz | tee conformance-v1-SHA256SUMS)

      - name: Upload conformance pack
        uses: actions/upload-artifact@v4
        with:
          name: conformance-pack-${{ steps.v.outputs.version }}
          path: /tmp/conformance-artifacts

  audit_packet:
    needs: [release_gate]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "${VERSION}" ]]; then
            echo "missing version" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build audit packet zip
        run: |
          set -euo pipefail
          OUT="/tmp/audit-artifacts"
          rm -rf "$OUT"
          mkdir -p "$OUT"

          node scripts/audit/build-audit-packet.mjs --out "$OUT" --packet-version v1
          (cd "$OUT" && sha256sum settld-audit-packet-v1.zip | tee settld-audit-packet-v1.zip.sha256)

      - name: Upload audit packet
        uses: actions/upload-artifact@v4
        with:
          name: audit-packet-${{ steps.v.outputs.version }}
          path: /tmp/audit-artifacts

  github_release:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [docker_image, helm_chart, npm_packages, python_publish, conformance_pack, audit_packet]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Compute version
        id: v
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
            TAG="v${VERSION}"
          else
            TAG="${GITHUB_REF_NAME}"
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - uses: actions/download-artifact@v4
        with:
          path: /tmp/release-artifacts

      - name: Prepare asset directory
        run: |
          set -euo pipefail
          mkdir -p /tmp/release-assets
          find /tmp/release-artifacts -type f -print0 | while IFS= read -r -d '' f; do
            cp "$f" /tmp/release-assets/
          done
          ls -la /tmp/release-assets

      - name: Assert required release assets exist
        run: |
          set -euo pipefail
          ls -la /tmp/release-assets
          test -f /tmp/release-assets/conformance-v1.tar.gz
          test -f /tmp/release-assets/conformance-v1-SHA256SUMS
          test -f /tmp/release-assets/settld-audit-packet-v1.zip
          test -f /tmp/release-assets/settld-audit-packet-v1.zip.sha256
          # npm tgz artifacts + checksums
          ls /tmp/release-assets/settld-api-sdk-*.tgz >/dev/null
          ls /tmp/release-assets/settld-artifact-produce-*.tgz >/dev/null
          ls /tmp/release-assets/settld-executor-sdk-*.tgz >/dev/null
          ls /tmp/release-assets/settld-artifact-verify-*.tgz >/dev/null
          ls /tmp/release-assets/settld-magic-link-cli-*.tgz >/dev/null
          ls /tmp/release-assets/settld-metering-adapter-sdk-*.tgz >/dev/null
          ls /tmp/release-assets/settld-*.tgz >/dev/null
          test -f /tmp/release-assets/npm-SHA256SUMS
          # python distribution artifacts + checksums
          ls /tmp/release-assets/settld_api_sdk_python-*.whl >/dev/null
          ls /tmp/release-assets/settld_api_sdk_python-*.tar.gz >/dev/null
          test -f /tmp/release-assets/python-SHA256SUMS

      - name: Generate ReleaseIndex.v1 (signed release manifest)
        run: |
          set -euo pipefail
          node scripts/release/generate-release-index.mjs --dir /tmp/release-assets --tag "${{ steps.v.outputs.tag }}" --version "${{ steps.v.outputs.version }}" --commit "${{ github.sha }}"

      - name: Sign ReleaseIndex.v1
        env:
          SETTLD_RELEASE_SIGNING_PRIVATE_KEY_PEM: ${{ secrets.SETTLD_RELEASE_SIGNING_PRIVATE_KEY_PEM }}
        run: |
          set -euo pipefail
          node scripts/release/sign-release-index.mjs --index /tmp/release-assets/release_index_v1.json --out /tmp/release-assets/release_index_v1.sig --private-key-env SETTLD_RELEASE_SIGNING_PRIVATE_KEY_PEM

      - name: Validate release assets (checksums + contents + ReleaseIndex signature)
        run: node scripts/release/validate-release-assets.mjs --dir /tmp/release-assets --release-trust trust/release-trust.json

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.v.outputs.tag }}
          name: ${{ steps.v.outputs.tag }}
          files: /tmp/release-assets/*
