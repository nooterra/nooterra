name: tests

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  pr_issue_link_guard:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Require linked Issue in PR body
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = (pr && pr.body) ? String(pr.body) : "";
            const ok =
              /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#\d+/i.test(body) ||
              /\brefs?\s+#\d+/i.test(body);
            if (!ok) {
              core.setFailed(
                "PR must link an Issue in the body (e.g. `Closes #123` or `Refs #123`)."
              );
            }

  changelog_guard:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Enforce CHANGELOG discipline for protocol/release-note PRs
        run: node scripts/ci/changelog-guard.mjs --base "${{ github.event.pull_request.base.sha }}" --head "${{ github.sha }}"

  unit_tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Assert repo/tool version consistency
        run: node scripts/ci/check-version-consistency.mjs
      - name: Run unit tests (includes PG-backed tests)
        run: npm test
        env:
          DATABASE_URL: postgres://postgres:test@127.0.0.1:5432/postgres

  magic_link_onboarding_live_contract:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run magic-link onboarding live contract gate
        run: node --test test/magic-link-onboarding-live-contract.test.js

  x402_quickstart_smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run x402 quickstart (CI mode)
        run: |
          set -euo pipefail
          SETTLD_QUICKSTART_KEEP_ALIVE=0 \
          HOLDBACK_BPS=2000 \
          DISPUTE_WINDOW_MS=3600000 \
          npm run quickstart:x402

  mcp_paid_call_kernel_suite:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run paid-call kernel suite (MCP + demo path)
        run: >
          node --test
          test/mcp-stdio-spike.test.js
          test/mcp-paid-exa-tool.test.js
          test/mcp-paid-weather-tool.test.js
          test/demo-mcp-paid-exa.test.js

  mcp_host_smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run MCP host smoke gate
        run: npm run -s test:ci:mcp-host-smoke
      - name: Upload MCP host smoke report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-host-smoke-${{ github.run_id }}
          path: artifacts/ops/mcp-host-smoke.json
          if-no-files-found: warn

  kernel_v0_ship_gate:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 35
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run Kernel v0 ship gate
        run: node scripts/ci/run-kernel-v0-ship-gate.mjs
      - name: Upload ship gate artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-v0-ship-gate-${{ github.run_id }}
          path: artifacts/gates/kernel-v0-ship-gate.json
          if-no-files-found: warn

  production_cutover_gate:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 35
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run production cutover gate
        run: npm run -s test:ops:production-cutover-gate
      - name: Upload production cutover gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: production-cutover-gate-${{ github.run_id }}
          path: |
            artifacts/gates/production-cutover-gate.json
            artifacts/ops/mcp-host-smoke.json
            artifacts/ops/mcp-host-cert-matrix.json
            artifacts/ops/x402-hitl-smoke.json
          if-no-files-found: warn

  flake_budget_guard:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Enforce flake budget policy
        run: node scripts/ci/flake-budget-guard.mjs

  deploy_safety_smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 5432:5432
    env:
      DATABASE_URL: postgres://postgres:test@127.0.0.1:5432/postgres
      RESTORE_DATABASE_URL: postgres://postgres:test@127.0.0.1:5432/postgres
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Runtime import smoke
        run: npm run -s test:ci:runtime-import-smoke
      - name: Secret hygiene guard
        run: npm run -s test:ci:secret-hygiene
      - name: Start Settld API (pg mode)
        run: |
          set -euo pipefail
          STORE=pg \
          NODE_ENV=production \
          DATABASE_URL="${DATABASE_URL}" \
          PROXY_PG_SCHEMA="deploy_safety_ci" \
          PROXY_MIGRATE_ON_STARTUP=1 \
          PROXY_OPS_TOKENS="ops_ci:ops_read,ops_write,finance_read,finance_write,audit_read" \
          PROXY_FINANCE_RECONCILE_ENABLED=1 \
          PROXY_MONEY_RAIL_RECONCILE_ENABLED=1 \
          PORT=3000 \
          node src/api/server.js &
          echo $! > /tmp/settld_pid
      - name: Wait for readiness
        run: |
          set -euo pipefail
          for i in $(seq 1 60); do
            if curl -fsS "http://127.0.0.1:3000/healthz" >/dev/null; then exit 0; fi
            sleep 1
          done
          echo "server did not become ready" >&2
          exit 1
      - name: Generate ephemeral signing key
        run: |
          set -euo pipefail
          openssl genpkey -algorithm Ed25519 -out /tmp/ops-ed25519.pem
          chmod 600 /tmp/ops-ed25519.pem
      - name: Run hosted baseline evidence gate (backup/restore required)
        run: |
          set -euo pipefail
          npm run -s ops:hosted-baseline:evidence -- \
            --base-url http://127.0.0.1:3000 \
            --tenant-id tenant_default \
            --ops-token ops_ci \
            --environment ci \
            --run-backup-restore true \
            --require-backup-restore true \
            --database-url "${DATABASE_URL}" \
            --restore-database-url "${RESTORE_DATABASE_URL}" \
            --backup-restore-jobs 1 \
            --signing-key-file /tmp/ops-ed25519.pem \
            --signature-key-id ops_ci_k1 \
            --out artifacts/ops/hosted-baseline-ci.json
      - name: Upload deploy safety artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-safety-${{ github.run_id }}
          path: |
            artifacts/ops/hosted-baseline-ci.json
      - name: Stop server
        if: always()
        run: |
          set -euo pipefail
          if [[ -f /tmp/settld_pid ]]; then kill "$(cat /tmp/settld_pid)" || true; fi

  openapi_drift:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Regenerate OpenAPI and assert no drift
        run: |
          set -euo pipefail
          npm run openapi:write
          git diff --exit-code -- openapi/settld.openapi.json

  npm_pack_smoke:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: npm pack + install smoke (settld-verify + settld-produce)
        run: node scripts/ci/npm-pack-smoke.mjs

  cli_cross_platform:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run CLI/conformance tests (no Postgres required)
        run: >
          node --test
          test/verify-cli-about.test.js
          test/verify-cli-json.test.js
          test/verify-cli-determinism.test.js
          test/verify-cli-sarif.test.js
          test/conformance-pack-v1.test.js
          test/verify-fixture-bundles.test.js

  python_verifier_conformance:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      - name: Install python deps (cryptography)
        run: |
          python -m pip install --upgrade pip
          python -m pip install cryptography
      - name: Run conformance pack v1 against python verifier
        run: node conformance/v1/run.mjs --bin reference/verifier-py/settld-verify-py

  github_action_settld_verify:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        bundle:
          - { kind: jobproof, path: test/fixtures/bundles/v1/jobproof/strict-pass }
          - { kind: monthproof, path: test/fixtures/bundles/v1/monthproof/strict-pass }
          - { kind: financepack, path: test/fixtures/bundles/v1/financepack/strict-pass }
    steps:
      - uses: actions/checkout@v4
      - name: Verify fixture bundle via composite action
        id: verify
        uses: ./.github/actions/settld-verify
        with:
          bundle_path: ${{ matrix.bundle.path }}
          strict: "true"
          fail_on_warnings: "false"
          hash_concurrency: "4"
          trust_file: test/fixtures/bundles/v1/trust.json
          output_json_path: settld-verify-${{ matrix.bundle.kind }}.json
      - name: Assert VerifyCliOutput.v1 shape
        run: |
          node -e '
            import fs from "node:fs";
            const p = process.env.OUT;
            const j = JSON.parse(fs.readFileSync(p, "utf8"));
            if (j?.schemaVersion !== "VerifyCliOutput.v1") throw new Error(`bad schemaVersion: ${j?.schemaVersion}`);
            if (j?.ok !== true) throw new Error(`verification failed: ${JSON.stringify(j)}`);
          '
        env:
          OUT: ${{ steps.verify.outputs.output_json_path }}
