name: throughput-drill-10x

on:
  workflow_dispatch: {}

concurrency:
  group: throughput-drill-10x
  cancel-in-progress: false

jobs:
  drill_10x:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: npm
      - uses: grafana/setup-k6-action@v1

      - name: Install dependencies
        run: npm ci

      - name: Start Nooterra API (pg mode)
        run: |
          set -euo pipefail
          STORE=pg \
          NODE_ENV=production \
          DATABASE_URL="postgres://postgres:test@127.0.0.1:5432/postgres" \
          PROXY_PG_SCHEMA="throughput_10x_ci" \
          PROXY_MIGRATE_ON_STARTUP=1 \
          PROXY_OPS_TOKENS="ops_ci:ops_read,ops_write,finance_read,finance_write,audit_read" \
          PORT=3000 \
          node src/api/server.js &
          echo $! > /tmp/nooterra_pid

      - name: Wait for readiness
        run: |
          set -euo pipefail
          for i in $(seq 1 60); do
            if curl -fsS "http://127.0.0.1:3000/healthz" >/dev/null; then exit 0; fi
            sleep 1
          done
          echo "server did not become ready" >&2
          exit 1

      - name: Run 10x throughput drill
        env:
          BASE_URL: http://127.0.0.1:3000
          OPS_TOKEN: ops_ci
          TENANTS: "3"
          ROBOTS_PER_TENANT: "3"
          BASELINE_JOBS_PER_MIN_PER_TENANT: "10"
          THROUGHPUT_MULTIPLIER: "10"
          DURATION: "120s"
          TARGET_P95_MS: "5000"
          MAX_FAILURE_RATE: "0.05"
          MAX_INGEST_REJECTED_PER_MIN: "50"
        run: node scripts/ci/run-10x-throughput-drill.mjs

      - name: Run incident rehearsal (degraded mode + rollback + comms)
        env:
          BASE_URL: http://127.0.0.1:3000
          OPS_TOKEN: ops_ci
        run: node scripts/ci/run-10x-throughput-incident-rehearsal.mjs

      - name: Upload drill artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: throughput-drill-10x-${{ github.run_id }}
          path: |
            artifacts/throughput/10x-drill-summary.json
            artifacts/throughput/10x-drill-k6-summary.json
            artifacts/throughput/10x-incident-rehearsal-summary.json
          if-no-files-found: warn

      - name: Stop server
        if: always()
        run: |
          set -euo pipefail
          if [[ -f /tmp/nooterra_pid ]]; then kill "$(cat /tmp/nooterra_pid)" || true; fi
