{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://settld.local/schemas/SettlementDecisionRecord.v2.schema.json",
  "title": "SettlementDecisionRecord.v2",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schemaVersion",
    "decisionId",
    "tenantId",
    "runId",
    "settlementId",
    "decisionStatus",
    "decisionMode",
    "policyRef",
    "policyHashUsed",
    "verifierRef",
    "workRef",
    "decidedAt",
    "decisionHash"
  ],
  "properties": {
    "schemaVersion": { "const": "SettlementDecisionRecord.v2" },
    "decisionId": { "type": "string", "minLength": 1, "maxLength": 200 },
    "tenantId": { "type": "string", "minLength": 1, "maxLength": 128, "pattern": "^[A-Za-z0-9:_-]+$" },
    "runId": { "type": "string", "minLength": 1, "maxLength": 128, "pattern": "^[A-Za-z0-9:_-]+$" },
    "settlementId": { "type": "string", "minLength": 1, "maxLength": 200 },
    "agreementId": { "type": ["string", "null"], "maxLength": 200 },
    "decisionStatus": { "type": "string", "enum": ["pending", "auto_resolved", "manual_review_required", "manual_resolved"] },
    "decisionMode": { "type": "string", "enum": ["automatic", "manual-review"] },
    "decisionReason": { "type": ["string", "null"], "maxLength": 2000 },
    "verificationStatus": { "type": ["string", "null"], "enum": ["green", "amber", "red", null] },
    "policyNormalizationVersion": { "type": "string", "minLength": 1, "maxLength": 64 },
    "policyRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["policyHash", "verificationMethodHash"],
      "properties": {
        "policyHash": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" },
        "verificationMethodHash": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" }
      }
    },
    "policyHashUsed": { "type": "string", "pattern": "^[0-9a-f]{64}$" },
    "profileHashUsed": { "type": "string", "pattern": "^[0-9a-f]{64}$" },
    "verificationMethodHashUsed": { "type": "string", "pattern": "^[0-9a-f]{64}$" },
    "verifierRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["verifierId", "verifierVersion", "verifierHash", "modality"],
      "properties": {
        "verifierId": { "type": ["string", "null"], "maxLength": 200 },
        "verifierVersion": { "type": ["string", "null"], "maxLength": 100 },
        "verifierHash": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" },
        "modality": { "type": ["string", "null"], "enum": ["deterministic", "attested", "discretionary", null] }
      }
    },
    "workRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["runStatus", "runLastEventId", "runLastChainHash", "resolutionEventId"],
      "properties": {
        "runStatus": { "type": ["string", "null"], "maxLength": 64 },
        "runLastEventId": { "type": ["string", "null"], "maxLength": 200 },
        "runLastChainHash": { "type": ["string", "null"], "maxLength": 200 },
        "resolutionEventId": { "type": ["string", "null"], "maxLength": 200 }
      }
    },
    "bindings": {
      "type": "object",
      "additionalProperties": false,
      "required": ["authorizationRef", "token", "request", "response", "providerSig", "reserve", "policyDecisionFingerprint"],
      "properties": {
        "authorizationRef": { "type": ["string", "null"], "maxLength": 200 },
        "token": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["kid", "sha256", "expiresAt"],
          "properties": {
            "kid": { "type": ["string", "null"], "maxLength": 200 },
            "sha256": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" },
            "expiresAt": { "type": ["string", "null"], "format": "date-time" }
          }
        },
        "request": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["sha256"],
          "properties": {
            "sha256": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" }
          }
        },
        "response": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["status", "sha256"],
          "properties": {
            "status": { "type": ["integer", "null"], "minimum": 100, "maximum": 999 },
            "sha256": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" }
          }
        },
        "providerSig": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["required", "present", "verified", "providerKeyId", "error"],
          "properties": {
            "required": { "type": ["boolean", "null"] },
            "present": { "type": ["boolean", "null"] },
            "verified": { "type": ["boolean", "null"] },
            "providerKeyId": { "type": ["string", "null"], "maxLength": 200 },
            "error": { "type": ["string", "null"], "maxLength": 4000 }
          }
        },
        "reserve": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["adapter", "mode", "reserveId", "status"],
          "properties": {
            "adapter": { "type": ["string", "null"], "maxLength": 200 },
            "mode": { "type": ["string", "null"], "maxLength": 200 },
            "reserveId": { "type": ["string", "null"], "maxLength": 256 },
            "status": { "type": ["string", "null"], "maxLength": 64 }
          }
        },
        "policyDecisionFingerprint": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": [
            "fingerprintVersion",
            "policyId",
            "policyVersion",
            "policyHash",
            "verificationMethodHash",
            "evaluationHash"
          ],
          "properties": {
            "fingerprintVersion": { "type": ["string", "null"], "maxLength": 64 },
            "policyId": { "type": ["string", "null"], "maxLength": 200 },
            "policyVersion": { "type": ["integer", "null"], "minimum": 1, "maximum": 1000000000 },
            "policyHash": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" },
            "verificationMethodHash": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" },
            "evaluationHash": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" }
          }
        }
      }
    },
    "decidedAt": { "type": "string", "format": "date-time" },
    "decisionHash": { "type": "string", "pattern": "^[0-9a-f]{64}$" }
  }
}
