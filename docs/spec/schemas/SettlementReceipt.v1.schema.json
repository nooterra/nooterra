{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://nooterra.local/schemas/SettlementReceipt.v1.schema.json",
  "title": "SettlementReceipt.v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schemaVersion",
    "receiptId",
    "tenantId",
    "runId",
    "settlementId",
    "decisionRef",
    "status",
    "amountCents",
    "releasedAmountCents",
    "refundedAmountCents",
    "releaseRatePct",
    "currency",
    "runStatus",
    "resolutionEventId",
    "finalityProvider",
    "finalityState",
    "settledAt",
    "createdAt",
    "receiptHash"
  ],
  "properties": {
    "schemaVersion": { "const": "SettlementReceipt.v1" },
    "receiptId": { "type": "string", "minLength": 1, "maxLength": 200 },
    "tenantId": { "type": "string", "minLength": 1, "maxLength": 128, "pattern": "^[A-Za-z0-9:_-]+$" },
    "runId": { "type": "string", "minLength": 1, "maxLength": 128, "pattern": "^[A-Za-z0-9:_-]+$" },
    "settlementId": { "type": "string", "minLength": 1, "maxLength": 200 },
    "decisionRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["decisionId", "decisionHash"],
      "properties": {
        "decisionId": { "type": "string", "minLength": 1, "maxLength": 200 },
        "decisionHash": { "type": "string", "pattern": "^[0-9a-f]{64}$" }
      }
    },
    "status": { "type": "string", "enum": ["locked", "released", "refunded"] },
    "amountCents": { "type": "integer", "minimum": 1 },
    "releasedAmountCents": { "type": "integer", "minimum": 0 },
    "refundedAmountCents": { "type": "integer", "minimum": 0 },
    "releaseRatePct": { "type": "integer", "minimum": 0, "maximum": 100 },
    "currency": { "type": "string", "minLength": 3, "maxLength": 12, "pattern": "^[A-Z][A-Z0-9_]{2,11}$" },
    "runStatus": { "type": ["string", "null"], "maxLength": 64 },
    "resolutionEventId": { "type": ["string", "null"], "maxLength": 200 },
    "finalityProvider": { "type": "string", "enum": ["internal_ledger"] },
    "finalityState": { "type": "string", "enum": ["pending", "final"] },
    "settledAt": { "type": ["string", "null"], "format": "date-time" },
    "bindings": {
      "type": "object",
      "additionalProperties": false,
      "required": ["authorizationRef", "token", "request", "response", "providerSig", "reserve", "policyDecisionFingerprint"],
      "properties": {
        "authorizationRef": { "type": ["string", "null"], "maxLength": 200 },
        "token": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["kid", "sha256", "expiresAt"],
          "properties": {
            "kid": { "type": ["string", "null"], "maxLength": 200 },
            "sha256": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" },
            "expiresAt": { "type": ["string", "null"], "format": "date-time" }
          }
        },
        "request": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["sha256"],
          "properties": {
            "sha256": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" }
          }
        },
        "response": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["status", "sha256"],
          "properties": {
            "status": { "type": ["integer", "null"], "minimum": 100, "maximum": 999 },
            "sha256": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" }
          }
        },
        "providerSig": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["required", "present", "verified", "providerKeyId", "error"],
          "properties": {
            "required": { "type": ["boolean", "null"] },
            "present": { "type": ["boolean", "null"] },
            "verified": { "type": ["boolean", "null"] },
            "providerKeyId": { "type": ["string", "null"], "maxLength": 200 },
            "error": { "type": ["string", "null"], "maxLength": 4000 }
          }
        },
        "reserve": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["adapter", "mode", "reserveId", "status"],
          "properties": {
            "adapter": { "type": ["string", "null"], "maxLength": 200 },
            "mode": { "type": ["string", "null"], "maxLength": 200 },
            "reserveId": { "type": ["string", "null"], "maxLength": 256 },
            "status": { "type": ["string", "null"], "maxLength": 64 }
          }
        },
        "policyDecisionFingerprint": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": [
            "fingerprintVersion",
            "policyId",
            "policyVersion",
            "policyHash",
            "verificationMethodHash",
            "evaluationHash"
          ],
          "properties": {
            "fingerprintVersion": { "type": ["string", "null"], "maxLength": 64 },
            "policyId": { "type": ["string", "null"], "maxLength": 200 },
            "policyVersion": { "type": ["integer", "null"], "minimum": 1, "maximum": 1000000000 },
            "policyHash": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" },
            "verificationMethodHash": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" },
            "evaluationHash": { "type": ["string", "null"], "pattern": "^[0-9a-f]{64}$" }
          }
        }
      }
    },
    "createdAt": { "type": "string", "format": "date-time" },
    "receiptHash": { "type": "string", "pattern": "^[0-9a-f]{64}$" }
  }
}
